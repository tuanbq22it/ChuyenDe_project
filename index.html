<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local CMS - Auto News</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f4f6f8; font-family: 'Segoe UI', sans-serif; }
        .card { border: none; border-radius: 10px; transition: all 0.3s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .nav-pills .nav-link.active { background-color: #0d6efd; font-weight: bold; }
        .nav-pills .nav-link { color: #555; }
        .status-label { position: absolute; top: 10px; right: 10px; font-size: 0.75rem; letter-spacing: 0.5px; }
        
        /* Loading ƒë·∫πp h∆°n */
        #loading {
            position: fixed; inset: 0; background: rgba(255,255,255,0.9);
            z-index: 9999; display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .spinner-grow { width: 3rem; height: 3rem; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark shadow mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">
                <i class="bi bi-hdd-network"></i> Admin Panel (Local)
            </a>
            <div class="d-flex align-items-center gap-3">
                <span class="text-light small opacity-75">
                    <i class="bi bi-globe"></i> K·∫øt n·ªëi t·ªõi: api.buiquoctuan.id.vn
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="fetchPosts()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="d-flex justify-content-center mb-4">
            <ul class="nav nav-pills bg-white p-1 rounded shadow-sm">
                <li class="nav-item">
                    <button class="nav-link active px-4" onclick="filterStatus('DRAFT')">
                        Ch·ªù duy·ªát <span class="badge bg-warning text-dark ms-1" id="countDraft">0</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link px-4" onclick="filterStatus('PUBLISHED')">
                        ƒê√£ ƒëƒÉng <span class="badge bg-success ms-1" id="countPub">0</span>
                    </button>
                </li>
            </ul>
        </div>

        <div class="row g-4" id="postsContainer">
            </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold text-primary">
                        <i class="bi bi-pencil-square"></i> Bi√™n t·∫≠p n·ªôi dung
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editId">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold text-secondary small">TI√äU ƒê·ªÄ</label>
                        <input type="text" class="form-control fw-bold" id="editTitle">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold text-secondary small">N·ªòI DUNG FACEBOOK</label>
                        <textarea class="form-control" id="editContent" rows="6" 
                            style="font-family: Consolas, monospace; font-size: 0.9rem; background-color: #f8f9fa;"></textarea>
                        <div class="form-text small">B·∫°n c√≥ th·ªÉ s·ª≠a l·∫°i l·ªùi d·∫´n, th√™m icon üî• ho·∫∑c hashtag #.</div>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <label class="form-label fw-bold text-secondary small">LINK ·∫¢NH</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-image"></i></span>
                                <input type="text" class="form-control" id="editImage" onchange="previewImg()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <img id="imgPreview" src="" class="img-fluid rounded border mt-2" style="max-height: 100px; width: 100%; object-fit: cover;">
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-light text-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-success px-4 fw-bold" onclick="approvePost()">
                        <i class="bi bi-send"></i> DUY·ªÜT & ƒêƒÇNG NGAY
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="loading">
        <div class="text-center">
            <div class="spinner-grow text-primary mb-3" role="status"></div>
            <h5 class="fw-light">ƒêang x·ª≠ l√Ω...</h5>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // üëâ ƒê·ªäA CH·ªà VPS C·ª¶A B·∫†N (S·ª≠a d√≤ng n√†y n·∫øu sau n√†y ƒë·ªïi domain)
        const API_BASE = 'https://api.buiquoctuan.id.vn/api/posts';
        
        let allPosts = [];
        let currentFilter = 'DRAFT';
        let editModal;

        document.addEventListener('DOMContentLoaded', () => {
            editModal = new bootstrap.Modal(document.getElementById('editModal'));
            fetchPosts();
        });

        // 1. T·∫£i d·ªØ li·ªáu
        async function fetchPosts() {
            showLoading(true);
            try {
                const res = await fetch(API_BASE);
                if(!res.ok) throw new Error('Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c Server');
                
                allPosts = await res.json();
                updateCounts();
                renderPosts();
            } catch (e) {
                document.getElementById('postsContainer').innerHTML = 
                    `<div class="col-12 text-center text-danger mt-5">
                        <h4><i class="bi bi-wifi-off"></i> L·ªói k·∫øt n·ªëi</h4>
                        <p>${e.message}</p>
                    </div>`;
            } finally {
                showLoading(false);
            }
        }

        // 2. C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng tr√™n Badge
        function updateCounts() {
            document.getElementById('countDraft').innerText = allPosts.filter(p => p.status === 'DRAFT').length;
            document.getElementById('countPub').innerText = allPosts.filter(p => p.status === 'PUBLISHED').length;
        }

        // 3. Hi·ªÉn th·ªã b√†i vi·∫øt
        function renderPosts() {
            const container = document.getElementById('postsContainer');
            container.innerHTML = '';

            const filtered = allPosts
                .filter(p => p.status === currentFilter)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            if(filtered.length === 0) {
                container.innerHTML = `<div class="col-12 text-center text-muted py-5">Kh√¥ng c√≥ b√†i vi·∫øt n√†o.</div>`;
                return;
            }

            filtered.forEach(post => {
                const date = new Date(post.createdAt).toLocaleString('vi-VN');
                const isDraft = post.status === 'DRAFT';
                const img = (post.imageUrl && post.imageUrl.startsWith('http')) ? post.imageUrl : 'https://via.placeholder.com/400x200?text=No+Image';

                const html = `
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100 border-${isDraft ? 'warning' : 'success'} shadow-sm">
                            <div class="position-relative">
                                <img src="${img}" class="card-img-top" style="height: 180px; object-fit: cover" onerror="this.src='https://via.placeholder.com/400x200'">
                                <span class="badge ${isDraft ? 'bg-warning text-dark' : 'bg-success'} status-label rounded-pill shadow-sm">
                                    ${post.status}
                                </span>
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h6 class="card-title fw-bold text-dark mb-2 text-truncate">${post.title}</h6>
                                <small class="text-muted mb-3"><i class="bi bi-clock"></i> ${date}</small>
                                
                                <div class="mt-auto">
                                    ${isDraft ? `
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-primary w-100 fw-bold" onclick="openEditModal('${post._id}')">
                                                <i class="bi bi-pencil-square"></i> BI√äN T·∫¨P
                                            </button>
                                            <button class="btn btn-outline-danger px-3" onclick="deletePost('${post._id}')" title="X√≥a b√†i vi·∫øt">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    ` : `
                                        <a href="${post.originalLink}" target="_blank" class="btn btn-outline-secondary w-100 btn-sm">
                                            <i class="bi bi-link-45deg"></i> Xem link g·ªëc
                                        </a>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        // 4. Chuy·ªÉn Tab
        function filterStatus(status) {
            currentFilter = status;
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            event.target.closest('.nav-link').classList.add('active');
            renderPosts();
        }

        // 5. M·ªü Modal S·ª≠a
        function openEditModal(id) {
            const post = allPosts.find(p => p._id === id);
            if(!post) return;

            document.getElementById('editId').value = post._id;
            document.getElementById('editTitle').value = post.title;
            document.getElementById('editContent').value = post.content;
            document.getElementById('editImage').value = post.imageUrl;
            document.getElementById('imgPreview').src = post.imageUrl;
            
            editModal.show();
        }

        function previewImg() {
            document.getElementById('imgPreview').src = document.getElementById('editImage').value;
        }

        // 6. G·ª≠i l·ªánh Duy·ªát
        async function approvePost() {
            const id = document.getElementById('editId').value;
            const data = {
                title: document.getElementById('editTitle').value,
                content: document.getElementById('editContent').value,
                imageUrl: document.getElementById('editImage').value
            };

            if(!confirm('X√°c nh·∫≠n ƒëƒÉng b√†i n√†y l√™n Facebook?')) return;

            editModal.hide();
            showLoading(true);

            try {
                // G·ªçi API tr√™n VPS
                const res = await fetch(`${API_BASE}/${id}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await res.json();
                
                if(result.success) {
                    alert('‚úÖ ƒê√£ g·ª≠i l·ªánh ƒëƒÉng th√†nh c√¥ng!');
                    // T·ª± ƒë·ªông t·∫£i l·∫°i sau 3 gi√¢y ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i
                    setTimeout(fetchPosts, 3000);
                } else {
                    alert('‚ùå C√≥ l·ªói: ' + result.message);
                    editModal.show();
                }
            } catch (e) {
                alert('L·ªói k·∫øt n·ªëi: ' + e.message);
                editModal.show();
            } finally {
                showLoading(false);
            }
        }

        // 7. X√≥a b√†i vi·∫øt
        async function deletePost(id) {
            if(!confirm('‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a vƒ©nh vi·ªÖn b√†i vi·∫øt n√†y kh√¥ng?')) return;
            
            showLoading(true);
            try {
                const res = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
                // N·∫øu x√≥a th√†nh c√¥ng, status c√≥ th·ªÉ l√† 200 ho·∫∑c 204
                if (res.ok) {
                    // X√≥a local tr∆∞·ªõc cho nhanh
                    allPosts = allPosts.filter(p => p._id !== id);
                    updateCounts();
                    renderPosts();
                } else {
                    alert('Kh√¥ng th·ªÉ x√≥a b√†i vi·∫øt. Vui l√≤ng th·ª≠ l·∫°i.');
                }
            } catch (e) {
                alert('L·ªói k·∫øt n·ªëi: ' + e.message);
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>